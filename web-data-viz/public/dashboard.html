<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Bring Me The Horizon Brasil</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/png" href="./images/favicon.png">
    <link rel="stylesheet" href="styles.css">
</head>

<body id="body_dashboard">
    <header>
        <div class="div_logo_site">
            <img src="./images/heart love Sticker by Bring Me The Horizon (1).gif" alt="" class="logo">
            <p class="logo_texto">Bring Me The Horizon Brasil</p>
        </div>
        <div class="links_header">
            <a href="curiosidades.html">Curiosidades</a>
            <a href="index.html">Sorteio</a>
        </div>
    </header>
    <div id="div_select_option">
        <div class="div_select">
            <label class="label_">Vote em seu album favorito:</label>
            <select id="select_album">
                <option value="Sempiternal">Sempiternal</option>
                <option value="Amo">Amo</option>
                <option value="SurivalHorror">Post Human: Survival Horror</option>
                <option value="NexGen">Post Human: Nex Gen</option>
                <option value="SuicideSeason">Suicide Season</option>
                <option value="CountYourBlessings">Count Your Blessings</option>
                <option value="theresAHell">Theres A Hell</option>
                <option value="ThatsTheSpirit">Thats The Spirit</option>
            </select>

        </div>
        <div class="div_select">
            <label class="label_">Vote em seu single favorito:</label>
            <select id="select_musica">
                <option value="CanYouFeelMyHeart">Can You Feel My Heart</option>
                <option value="BlessedWithACurse">Blessed With A Curse</option>
                <option value="Doomed">Doomed</option>
                <option value="ShadowMoses">Shadow Moses</option>
                <option value="Teardrops">Teardrops</option>
                <option value="Mantra">Mantra</option>
                <option value="KoolAid">Kool-Aid</option>
                <option value="Drown">Drown</option>
                <option value="PrayForPlagues">Pray For Plagues</option>
                <option value="Throne">Throne</option>
                <option value="ChelseaSmile">Chelsea Smile</option>
            </select>

            <button onclick="enviarVoto()" id="botao_select">Votar</button>
        </div>
    </div>

    <div id="div_kpis">
        <div id="kpiAlbum"></div>
        <div id="kpiMusica"></div>
    </div>
    <h1>Dashboard</h1>
    <div class="div_canvas">
        <div id="div_album">
            <h3>Votos por Álbum:</h3>
            <canvas id="Albuns"></canvas>
        </div>
        <div id="div_musica">
            <h3>Votos por Música:</h3>
            <canvas id="Musicas"></canvas>
        </div>
    </div>

</body>
<script>
    function enviarVoto() {
        const album = select_album.value;
        const musica = select_musica.value;
        const usuario = sessionStorage.getItem("ID_USUARIO");

        fetch("/medidas/votar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ album, musica, usuario })
        })
            .then(() => {
                obterDadosGraficoAlbum();
                obterDadosGraficoMusica();
            })
            .catch(console.error);
    }
    window.onload = function () {
        obterDadosGraficoAlbum();
        obterDadosGraficoMusica();

    }
    function obterDadosGraficoAlbum() {

        fetch("/medidas/album", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    var tituloAlbum = []
                    var qtdVotosAlbum = []
                    for (var i = 0; i < json.length; i++) {
                        tituloAlbum[i] = json[i].Album_Favorito;
                        qtdVotosAlbum[i] = json[i].votos;
                    }
                    console.log(json);
                    console.log(JSON.stringify(json));
                    plotarGraficoAlbum(tituloAlbum, qtdVotosAlbum)

                });

            } else {
                console.log("Houve um erro ao tentar realizar o login!");
            }

        }).catch(function (erro) {
            console.log(erro);
        })
    }
    function plotarGraficoAlbum(tituloAlbum, qtdVotosAlbum) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = tituloAlbum;

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Albuns favoritos',
                data: qtdVotosAlbum,
                backgroundColor: ['#a526ffd0',
                    '#26b7ffd0',
                    '#7CFD15',
                    '#ff8026d0',
                    '#76100e',
                    '#ff26bad0',
                    '#263cffd0',
                    '#31ff26d0',

                ],
                tension: 0.1
            }]
        };
        console.log(labels)
        console.log(qtdVotosAlbum)

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGraficoAlbum" e passados para "plotarGrafico":')
        const config = {
            type: 'bar',
            data: dados,
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            },
        };

        // Adicionando gráfico criado em div na tela
        let myChart2 = new Chart(
            document.getElementById('Albuns'),
            config
        );
    }
    function obterDadosGraficoMusica() {

        fetch("/medidas/musicas", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    var tituloMusica = []
                    var qtdVotosMusica = []
                    for (var i = 0; i < json.length; i++) {
                        tituloMusica[i] = json[i].Musica_Favorita;
                        qtdVotosMusica[i] = json[i].votos;
                    }
                    console.log(json);
                    console.log(JSON.stringify(json));
                    plotarGraficoMusica(tituloMusica, qtdVotosMusica)

                });

            } else {
                console.log("Houve um erro ao tentar realizar o login!");
            }

        }).catch(function (erro) {
            console.log(erro);
        })
    }

    function plotarGraficoMusica(tituloMusica, qtdVotosMusica) {
        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = tituloMusica;

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Músicas Favoritas',
                data: qtdVotosMusica,
                backgroundColor: ['#ff8026d0',
                    '#76100e',
                    '#ff26bad0',
                    '#263cffd0',
                    '#31ff26d0',
                    '#7CFD15',
                    '#26b7ffd0',
                    '#a526ffd0',
                    '#ff785ad0',
                    '#faff5ad0',
                    '#5a86ffd0'
                ],
                tension: 0.1
            }]
        };
        console.log(labels)
        console.log(qtdVotosMusica)

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGraficoAlbum" e passados para "plotarGrafico":')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            },
        };

        // Adicionando gráfico criado em div na tela
        let myChart1 = new Chart(
            document.getElementById('Musicas'),
            config
        );

        //setTimeout(() => atualizarGrafico(dados, myChart), 2000);
    }
    fetch("/votos/musicaMaisVotada")
        .then(res => res.json())
        .then(data => {
            kpiMusica.innerHTML = `<h2> Música mais votada: </h2> ${data.musica_mais_votada} (${data.total_votos} votos)`;
        });

    fetch("/votos/albumMaisVotado")
        .then(res => res.json())
        .then(data => {
            kpiAlbum.innerHTML = `<h2> Álbum mais votado: </h2> ${data.album_mais_votado} (${data.total_votos} votos)`;
        });
</script>

</html>